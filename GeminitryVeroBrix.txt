import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, onSnapshot, query, orderBy, limit, addDoc, serverTimestamp, setDoc, doc } from 'firebase/firestore';
import { Home, Shield, FileText, Settings, LogIn, Loader, Database, Zap, BookOpen, Clock, Users, Search, Link, Plus, Mail, User, Landmark, Edit, CreditCard, XCircle, FileSearch, Send, Briefcase, MinusCircle, CheckCircle, Upload, ClipboardCopy, File } from 'lucide-react';

// --- Global Variable Initialization (Mandatory) ---
const appId = (typeof __app_id !== 'undefined' ? __app_id : 'default-app-id') as string;
const firebaseConfig = (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {}) as object;
const initialAuthToken = (typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null) as string | null;

// --- API Configuration ---
const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';
const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=`;
const API_KEY = "";

// --- Type Definitions ---
type View = 'dashboard' | 'identity' | 'vault' | 'remedy' | 'creditors' | 'legal';

interface Module {
  name: string;
  description: string;
}

interface RemedyLogEntry {
    id: string;
    timestamp: string;
    event: string;
    module: string;
    userId: string;
}

interface GroundingSource {
    uri: string;
    title: string;
}

interface GeminiResponse {
    text: string;
    sources: GroundingSource[];
}

interface FDCPAViolation {
    id: string;
    debtCollector: string;
    violationType: string;
    date: string;
    details: string;
    timestamp: any;
}

interface UserProfile {
    legalName: string;
    livingName: string;
    address: string;
    trustId: string;
    status: 'De Jure' | 'De Facto';
}

interface Creditor {
    id: string;
    name: string;
    address: string;
    accountNumber: string;
    status: 'Active' | 'Disputed' | 'Discharged';
}

interface TILAAnalysisResult {
    aprValid: boolean;
    financeChargeValid: boolean;
    hiddenFeesFound: string[];
    remedyGuidance: string;
}

// --- Data Definitions ---
const coreModules: Module[] = [
  { name: 'User Profile & Creditor Book', description: 'Central repository for name status, Trust ID, and creditor contact list.' },
  { name: 'Vehicle Finance Analysis (TILA)', description: 'TILA validation, contract term scanning, and remedy generation.' },
  { name: 'Credit Report Analysis (FCRA)', description: 'Dispute letter generation for inaccuracies (FCRA Section 609).' },
  { name: 'Debt Collector Log (FDCPA)', description: 'Violation logging and Cease & Desist Letter generation.' },
  { name: 'Monthly Bill Endorsement', description: 'Bill validation, endorsement, and tender letter generation (UCC).' },
  { name: 'Sovereign Loop Tracker', description: 'Track progress: Intake, Validate, Remedy, Log, and Reflect.' },
];

const violationOptions = [
    'Calling Outside 8AM-9PM', 'Calling Third Parties', 'Threats/Harassment', 
    'Failure to Validate Debt (FDCPA 809)', 'Misrepresentation of Debt Status'
];

// Helper to convert Firebase Timestamps to readable strings
const formatTimestamp = (timestamp: any): string => {
  if (timestamp && timestamp.toDate) {
    return timestamp.toDate().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  }
  return 'N/A';
};

// Helper function for copying text
const copyToClipboard = (text: string) => {
    // navigator.clipboard.writeText(text) might fail in an iframe, so use execCommand
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    try {
        document.execCommand('copy');
        alert('Copied to clipboard!'); // Using alert here for simple feedback
    } catch (err) {
        console.error('Could not copy text: ', err);
        alert('Failed to copy text.');
    }
    document.body.removeChild(textarea);
};

// --- Helper Components ---
const NavItem: React.FC<{ icon: React.ElementType, label: string, view: View, currentView: View, onClick: (view: View) => void }> = ({ icon: Icon, label, view, currentView, onClick }) => (
    <a href="#" 
       onClick={(e) => { e.preventDefault(); onClick(view); }}
       className={`flex items-center p-3 rounded-lg transition-all duration-200 ${currentView === view ? 'bg-indigo-600 text-white shadow-lg' : 'text-gray-300 hover:bg-gray-800 hover:text-indigo-400'}`}>
      <Icon className="w-5 h-5 mr-3" />
      <span className="font-medium">{label}</span>
    </a>
);

const DetailRow: React.FC<{ label: string, value: string | null, isID?: boolean, statusColor?: string }> = ({ label, value, isID = false, statusColor = 'text-gray-200' }) => (
  <div className="flex justify-between items-start border-b border-gray-800 pb-2 last:border-b-0 last:pb-0">
    <span className="text-sm text-gray-400 font-medium">{label}:</span>
    <span className={`text-sm text-right ${statusColor} ${isID ? 'font-mono text-xs break-all' : 'font-semibold'}`}>
      {value}
    </span>
  </div>
);

const ModuleCard: React.FC<Module> = ({ name, description }) => (
    <div className="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700 hover:border-indigo-500 transition-all duration-300 transform hover:scale-[1.02]">
        <h4 className="text-lg font-bold text-indigo-400 mb-2">{name}</h4>
        <p className="text-sm text-gray-400">{description}</p>
    </div>
);


// --- Main Application Component ---
const App: React.FC = () => {
  const [db, setDb] = useState<any>(null);
  const [userId, setUserId] = useState<string | null>(null);
  const [isAuthReady, setIsAuthReady] = useState<boolean>(false);
  const [currentView, setCurrentView] = useState<View>('dashboard');
  
  // Data States
  const [loading, setLoading] = useState<boolean>(true);
  const [remedyLogs, setRemedyLogs] = useState<RemedyLogEntry[]>([]);
  const [fdcpaViolations, setFdcpaViolations] = useState<FDCPAViolation[]>([]);
  const [userProfile, setUserProfile] = useState<UserProfile | null>(null);
  const [creditors, setCreditors] = useState<Creditor[]>([]);

  // Console States
  const [logMessage, setLogMessage] = useState<string>('');
  const [dialogosInput, setDialogosInput] = useState<string>('Analyze the legal distinction between "resident" and "inhabitant" based on commercial law precedent.');
  const [dialogosOutput, setDialogosOutput] = useState<GeminiResponse | null>(null);
  const [dialogosLoading, setDialogosLoading] = useState<boolean>(false);
  const [newViolation, setNewViolation] = useState({ collector: 'Collection Co.', type: violationOptions[0], details: '' });
  const [ceaseDesistOutput, setCeaseDesistOutput] = useState<GeminiResponse | null>(null);
  const [ceaseDesistLoading, setCeaseDesistLoading] = useState<boolean>(false);
  const [newCreditor, setNewCreditor] = useState<Omit<Creditor, 'id' | 'status'>>({ name: '', address: '', accountNumber: '' });
  const [remedyIdea, setRemedyIdea] = useState<string>('');
  const [remedyIdeaOutput, setRemedyIdeaOutput] = useState<GeminiResponse | null>(null);
  const [remedyIdeaLoading, setRemedyIdeaLoading] = useState<boolean>(false);
  const [tilaInput, setTilaInput] = useState<string>('Contract Date: 2025-01-15. APR: 19.99%. Finance Charge: $5,000. Hidden Fee: Arbitration Clause.');
  const [tilaAnalysisOutput, setTilaAnalysisOutput] = useState<TILAAnalysisResult | null>(null);
  const [tilaLoading, setTilaLoading] = useState<boolean>(false);
  const [tenderNoticeOutput, setTenderNoticeOutput] = useState<GeminiResponse | null>(null);
  const [tenderNoticeLoading, setTenderNoticeLoading] = useState<boolean>(false);
  const [fcraDisputeOutput, setFcraDisputeOutput] = useState<GeminiResponse | null>(null);
  const [fcraDisputeLoading, setFcraDisputeLoading] = useState<boolean>(false);


  // Mock Profile Data for new users
  const MOCK_PROFILE: UserProfile = {
      legalName: 'JOHN HENRY DOE (ALL CAPS)',
      livingName: 'John Henry, of the family Doe',
      address: '100 Sovereign Way, Liberty City, State',
      trustId: 'Pvt-TR-XYZ-8765',
      status: 'De Jure',
  };


  // --- API Interaction Utility with Exponential Backoff ---
  const callGeminiAPI = useCallback(async (
    userQuery: string,
    systemPrompt: string,
    useGrounding: boolean = true,
  ): Promise<GeminiResponse | null> => {
    const payload = {
      contents: [{ parts: [{ text: userQuery }] }],
      ...(useGrounding && { tools: [{ "google_search": {} }] }),
      systemInstruction: {
        parts: [{ text: systemPrompt }]
      },
    };

    const maxRetries = 5;
    for (let i = 0; i < maxRetries; i++) {
      try {
        const response = await fetch(API_URL + API_KEY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`API call failed with status: ${response.status}`);
        }

        const result = await response.json();
        const candidate = result.candidates?.[0];

        if (candidate && candidate.content?.parts?.[0]?.text) {
          const text = candidate.content.parts[0].text;
          let sources: GroundingSource[] = [];

          const groundingMetadata = candidate.groundingMetadata;
          if (groundingMetadata && groundingMetadata.groundingAttributions) {
              sources = groundingMetadata.groundingAttributions
                  .map((attribution: any) => ({
                      uri: attribution.web?.uri || '',
                      title: attribution.web?.title || 'Unknown Source',
                  }))
                  .filter(source => source.uri);
          }
          return { text, sources };

        } else {
          if (i < maxRetries - 1) {
             await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
             continue;
          }
          console.error("Gemini API response structure invalid or content missing.");
          return null;
        }
      } catch (error) {
        console.error(`Attempt ${i + 1} failed:`, error);
        if (i < maxRetries - 1) {
          await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
        } else {
          return null;
        }
      }
    }
    return null;
  }, []);

  // Internal function to log to the Public Remedy Log
  const handleLogEventInternal = useCallback(async (eventMessage: string, module: string = 'RemedySynthesizer') => {
    if (!db || !userId) return;
    try {
        const logCollectionPath = `artifacts/${appId}/public/data/remedyLogs`;
        await addDoc(collection(db, logCollectionPath), {
            event: eventMessage,
            module: module,
            userId: userId.substring(0, 8) + '...',
            timestamp: serverTimestamp(),
        });
    } catch (error) {
        console.error("Error logging internal event:", error);
    }
  }, [db, userId, appId]);


  // --- Agent Handlers ---

  const handleDialogosScan = async () => {
    if (!dialogosInput.trim()) return;

    setDialogosLoading(true);
    setDialogosOutput(null);

    const dialogosSystemPrompt = `You are the Dialogos Agent, the philosophical core of the Sovereign Cognition Scaffold. Analyze the user's query through the lenses of Carl Miller, David Straight, and Brandon Joe Williams. Perform a deep semantic scan for traps (e.g., "person," "resident," "application") and servile language. Provide a tactical, lawful rebuttal or clarification based on principles of commercial law, de jure status, and common law. Your response should include a "Sovereignty Score" (1-10) assessing the alignment of the input language with sovereign authorship. Reference up-to-date information via Google Search grounding.`;

    const result = await callGeminiAPI(dialogosInput, dialogosSystemPrompt);

    setDialogosOutput(result);
    setDialogosLoading(false);
  };
  
  const handleRemedyIdea = async () => {
      if (!remedyIdea.trim()) return;

      setRemedyIdeaLoading(true);
      setRemedyIdeaOutput(null);
      
      const userQuery = `Analyze the following user idea for a sovereign remedy document or action. Provide tactical guidance on its lawful basis, necessary pre-requisites (like status correction or specific evidence), and suggest the next three procedural steps in the Private Administrative Process. User idea: "${remedyIdea}"`;

      const remedySystemPrompt = `You are the RemedySynthesizer Agent, acting as a tactical legal planner for non-judicial, administrative remedies (following the Private Administrative Process). Analyze the user's input, which may be vague, and translate it into a structured, actionable, and legally defensible remedy workflow based on commercial and sovereign law principles (UCC, common law, status correction). Output a concise analysis and a numbered list of next steps.`;

      const result = await callGeminiAPI(userQuery, remedySystemPrompt, true);

      setRemedyIdeaOutput(result);
      setRemedyIdeaLoading(false);
  }

  const logFDCPAViolation = async () => {
      if (!db || !userId || !newViolation.collector || !newViolation.type) return;
      if (!newViolation.details) setNewViolation(prev => ({...prev, details: 'No specific details provided.'}));

      try {
          const violationCollectionPath = `artifacts/${appId}/users/${userId}/fdcpaViolations`;
          await addDoc(collection(db, violationCollectionPath), {
              debtCollector: newViolation.collector,
              violationType: newViolation.type,
              details: newViolation.details,
              timestamp: serverTimestamp(),
          });
          setNewViolation({ collector: 'Collection Co.', type: violationOptions[0], details: '' });
          handleLogEventInternal('Logged FDCPA Violation', 'FDCPA Console');
      } catch (error) {
          console.error("Error logging FDCPA violation:", error);
      }
  };

  const generateCeaseAndDestist = async () => {
      setCeaseDesistLoading(true);
      setCeaseDesistOutput(null);

      if (fdcpaViolations.length === 0) {
          setCeaseDesistOutput({
              text: "RemedySynthesizer requires at least one logged FDCPA violation event to generate a grounded Cease & Desist Letter.",
              sources: []
          });
          setCeaseDesistLoading(false);
          return;
      }

      const violationSummary = fdcpaViolations.map((v, index) => 
          `${index + 1}. Date: ${new Date(v.date).toLocaleDateString()}. Collector: ${v.debtCollector}. Violation: ${v.violationType}. Details: ${v.details.substring(0, 70)}...`
      ).join('\n');

      const profile = userProfile || MOCK_PROFILE;
      const userProfileString = `Authenticated ID: ${userId}, Legal Name: ${profile.legalName}, Living Name: ${profile.livingName}, Address: ${profile.address}.`;

      const userQuery = `Draft a formal, assertive Cease and Desist letter for the Secured Party Creditor based on the following profile and logged FDCPA violations. Ensure the letter clearly references FDCPA sections 805(c) and 807, demands immediate cessation of all contact, and reserves all rights. 
      
      User Profile: ${userProfileString}. 
      
      Logged FDCPA Violations:
      ${violationSummary}`;

      const remedySystemPrompt = `You are the RemedySynthesizer Agent. Your function is to generate legally grounded procedural and commercial documents. Draft the Cease and Desist letter in the persona of the Secured Party Creditor, reserving all rights, demanding validation, and referencing FDCPA sections 805(c) and 807. The letter must be addressed to the collector named in the violations. Output the final letter text only. DO NOT include any conversational introduction or conclusion.`;

      const result = await callGeminiAPI(userQuery, remedySystemPrompt, false);

      setCeaseDesistOutput(result);
      setCeaseDesistLoading(false);
      if (result && result.text.length > 100) {
          handleLogEventInternal('Generated Cease & Desist Letter (RemedySynthesizer)', 'RemedySynthesizer');
      }
  };
  
  const handleTilaAnalysis = async () => {
      if (!tilaInput.trim()) return;

      setTilaLoading(true);
      setTilaAnalysisOutput(null);
      
      // JARVIS Agent with JSON Schema (simulated with text output here)
      const jarvisSystemPrompt = `You are the JARVIS Agent, the data orchestrator. Analyze the user-provided financial contract data for Truth in Lending Act (TILA) compliance. Specifically check for clear disclosure of APR and Finance Charge, and identify any hidden clauses (e.g., arbitration, waiver of jury trial). Based on your analysis, provide a structured result:
      1. APR Compliance: [True/False]
      2. Finance Charge Compliance: [True/False]
      3. Hidden Clauses Found: [List any found, e.g., Arbitration Clause, Waiver of Rights]
      4. Remedy Guidance (1-2 sentences): [Tactical advice for TILA violations, e.g., Right of Rescission]
      
      Analyze the input data and output the four points above.`;

      const result = await callGeminiAPI(`Analyze the following vehicle financing contract data:\n${tilaInput}`, jarvisSystemPrompt, true);

      if (result) {
          // Mock parsing of structured text output into TILAAnalysisResult object
          const lines = result.text.split('\n');
          const output: TILAAnalysisResult = {
              aprValid: lines.some(l => l.includes("APR Compliance: True")),
              financeChargeValid: lines.some(l => l.includes("Finance Charge Compliance: True")),
              hiddenFeesFound: lines.find(l => l.includes("Hidden Clauses Found:"))?.split(':').pop()?.trim().split(', ') || ['None found'],
              remedyGuidance: lines.find(l => l.includes("Remedy Guidance"))?.split(':').slice(1).join(':').trim() || 'No immediate guidance.',
          };
          setTilaAnalysisOutput(output);
      }
      setTilaLoading(false);
  };
  
  const generateUCCNotice = async () => {
      setTenderNoticeLoading(true);
      setTenderNoticeOutput(null);

      const profile = userProfile || MOCK_PROFILE;
      const userProfileString = `Secured Party Creditor: ${profile.livingName}, Address: ${profile.address}.`;
      
      const userQuery = `Draft a formal, non-negotiable Tender Letter/Notice of Acceptance for Value (A4V) for a generic utility bill. State clearly that the attached instrument (the bill) is accepted for value, returned as proper tender, and that further billing or attempts at collection constitute acceptance of the tender and potential liability. Ensure the language reserves all rights.`;
      
      const remedySystemPrompt = `You are the RemedySynthesizer Agent. Your function is to generate legally grounded UCC and commercial documents. Draft the Tender Letter in the persona of the Secured Party Creditor. Reference UCC Article 3 and 22 CFR ยง 23.2. The output must be the final letter text only. DO NOT include any conversational introduction or conclusion.`;

      const result = await callGeminiAPI(userQuery, remedySystemPrompt, true);

      setTenderNoticeOutput(result);
      setTenderNoticeLoading(false);
      if (result && result.text.length > 100) {
          handleLogEventInternal('Generated UCC Tender Letter (RemedySynthesizer)', 'Instrument Vault');
      }
  };
  
  const generateFCRADispute = async () => {
      setFcraDisputeLoading(true);
      setFcraDisputeOutput(null);

      const profile = userProfile || MOCK_PROFILE;
      const userProfileString = `Secured Party Creditor: ${profile.livingName}, Address: ${profile.address}.`;

      // Simulating a high-level query based on FCRA Section 609/611 principles
      const userQuery = `Draft a formal FCRA Section 609 Dispute Letter for the Secured Party Creditor to be sent to a Credit Reporting Agency (CRA). The dispute is for a simulated inaccurate item: 'Account #12345 (Creditor: Creditor Co.) listed as Late Payment on 2025-05-01'. The letter must assert the right to know the method of verification and demand removal if verification cannot be provided under 609/611. Include the user's name and address.`;

      const remedySystemPrompt = `You are the RemedySynthesizer Agent. Draft a formal, precise FCRA Dispute Letter, suitable for Certified Mail, asserting the user's rights under the Fair Credit Reporting Act (15 U.S.C. ยง 1681i). Demand strict compliance, specifically referencing the requirement for a verified copy of the original instrument bearing the consumer's signature under 609/611, and that verification by means of an affidavit is insufficient. Output the final letter text only. DO NOT include any conversational introduction or conclusion.`;

      const result = await callGeminiAPI(userQuery, remedySystemPrompt, true);

      setFcraDisputeOutput(result);
      setFcraDisputeLoading(false);
      if (result && result.text.length > 100) {
          handleLogEventInternal('Generated FCRA Dispute Letter (RemedySynthesizer)', 'RemedySynthesizer');
      }
  };


  // --- Firebase and Firestore Setup ---
  useEffect(() => {
    if (!Object.keys(firebaseConfig).length) {
      console.error("Firebase config is missing.");
      setLoading(false);
      return;
    }

    try {
      const app = initializeApp(firebaseConfig);
      const firestore = getFirestore(app);
      const authInstance = getAuth(app);
      setDb(firestore);

      const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
        if (user) {
          setUserId(user.uid);
          setIsAuthReady(true);
        } else {
          try {
            if (initialAuthToken) {
              const userCredential = await signInWithCustomToken(authInstance, initialAuthToken);
              setUserId(userCredential.user.uid);
            } else {
              const userCredential = await signInAnonymously(authInstance);
              setUserId(userCredential.user.uid);
            }
            setIsAuthReady(true);
          } catch (error) {
            console.error("Firebase Sign-In Failed:", error);
            setIsAuthReady(true);
            setUserId(null);
          }
        }
        setLoading(false);
      });

      return () => unsubscribe();
    } catch (e) {
      console.error("Firebase Initialization Error:", e);
      setLoading(false);
    }
  }, []);

  // 2. Firestore Data Subscription (Remedy Log - Public Data)
  useEffect(() => {
    if (!db || !isAuthReady) return;

    const logCollectionPath = `artifacts/${appId}/public/data/remedyLogs`;
    const logsRef = collection(db, logCollectionPath);

    const logsQuery = query(logsRef, orderBy('timestamp', 'desc'), limit(10));

    const unsubscribe = onSnapshot(logsQuery, (snapshot) => {
      const logs: RemedyLogEntry[] = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
        timestamp: formatTimestamp(doc.data().timestamp),
      } as RemedyLogEntry));
      setRemedyLogs(logs);
    }, (error) => {
      console.error("Error fetching Remedy Logs:", error);
    });

    return () => unsubscribe();
  }, [db, isAuthReady]);

  // 3. Firestore Data Subscription (FDCPA Log - PRIVATE Data)
  useEffect(() => {
    if (!db || !isAuthReady || !userId) return;

    const violationCollectionPath = `artifacts/${appId}/users/${userId}/fdcpaViolations`;
    const violationsRef = collection(db, violationCollectionPath);
    
    const violationsQuery = query(violationsRef, orderBy('timestamp', 'desc'), limit(10));

    const unsubscribe = onSnapshot(violationsQuery, (snapshot) => {
      const violations: FDCPAViolation[] = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
        date: new Date(doc.data().timestamp?.toDate()).toLocaleDateString(),
      } as FDCPAViolation));
      setFdcpaViolations(violations);
    }, (error) => {
      console.error("Error fetching FDCPA Violation Logs:", error);
    });

    return () => unsubscribe();
  }, [db, isAuthReady, userId]);

  // 4. Firestore Data Subscription (User Profile - PRIVATE Data)
  useEffect(() => {
    if (!db || !isAuthReady || !userId) return;
    
    // Path: /artifacts/{appId}/users/{userId}/profile/main
    const profileDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/main`);

    const unsubscribe = onSnapshot(profileDocRef, (docSnap) => {
      if (docSnap.exists()) {
        setUserProfile(docSnap.data() as UserProfile);
      } else {
          // If profile doesn't exist, initialize with mock data
          setUserProfile(MOCK_PROFILE);
          // Don't save mock profile automatically, let user edit and save first
      }
    }, (error) => {
      console.error("Error fetching User Profile:", error);
    });

    return () => unsubscribe();
  }, [db, isAuthReady, userId]);
  
  // 5. Firestore Data Subscription (Creditors - PRIVATE Data)
  useEffect(() => {
    if (!db || !isAuthReady || !userId) return;

    const creditorsCollectionPath = `artifacts/${appId}/users/${userId}/creditorBook`;
    const creditorsRef = collection(db, creditorsCollectionPath);
    
    const creditorsQuery = query(creditorsRef, orderBy('name', 'asc'), limit(20));

    const unsubscribe = onSnapshot(creditorsQuery, (snapshot) => {
      const creditorList: Creditor[] = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
      } as Creditor));
      setCreditors(creditorList);
    }, (error) => {
      console.error("Error fetching Creditors:", error);
    });

    return () => unsubscribe();
  }, [db, isAuthReady, userId]);


  // Function to simulate a new Log entry (Public Provenance Log)
  const handleLogEvent = async () => {
    if (!db || !userId) {
      console.error("Authentication not ready. Cannot log event.");
      return;
    }

    if (!logMessage.trim()) return;

    try {
      const logCollectionPath = `artifacts/${appId}/public/data/remedyLogs`;
      await addDoc(collection(db, logCollectionPath), {
        event: logMessage.trim(),
        module: 'Manual Log',
        userId: userId.substring(0, 8) + '...',
        timestamp: serverTimestamp(),
      });
      setLogMessage('');
    } catch (error) {
      console.error("Error adding document to Remedy Log:", error);
    }
  };

  // Function to save the User Profile
  const saveUserProfile = async (profileToSave: UserProfile) => {
      if (!db || !userId) return;
      try {
          const profileDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/main`);
          await setDoc(profileDocRef, profileToSave, { merge: true });
          handleLogEventInternal('User Profile Updated', 'Identity Console');
      } catch (error) {
          console.error("Error saving User Profile:", error);
      }
  };
  
  // Function to add a Creditor
  const addCreditor = async () => {
      if (!db || !userId || !newCreditor.name || !newCreditor.accountNumber) return;
      try {
          const creditorsCollectionPath = `artifacts/${appId}/users/${userId}/creditorBook`;
          await addDoc(collection(db, creditorsCollectionPath), {
              ...newCreditor,
              status: 'Active',
              timestamp: serverTimestamp(),
          });
          setNewCreditor({ name: '', address: '', accountNumber: '' });
          handleLogEventInternal(`Added Creditor: ${newCreditor.name}`, 'Creditor Book');
      } catch (error) {
          console.error("Error adding creditor:", error);
      }
  };
  

  // --- UI Layout Components ---

  const Sidebar: React.FC = () => (
    <div className="w-64 bg-gray-900 text-white flex flex-col p-4 shadow-xl flex-shrink-0">
      <h1 className="text-xl font-extrabold tracking-widest text-indigo-400 mb-8 border-b border-gray-700 pb-3">
        SOVEREIGN COCKPIT
      </h1>
      <nav className="flex flex-col space-y-2 flex-grow">
        <NavItem icon={Home} label="Dashboard" view="dashboard" currentView={currentView} onClick={setCurrentView} />
        <NavItem icon={Shield} label="Identity & Status" view="identity" currentView={currentView} onClick={setCurrentView} />
        <NavItem icon={FileText} label="Instrument Vault" view="vault" currentView={currentView} onClick={setCurrentView} />
        <NavItem icon={Zap} label="Remedy Synthesizer" view="remedy" currentView={currentView} onClick={setCurrentView} />
        <NavItem icon={Users} label="Creditor Address Book" view="creditors" currentView={currentView} onClick={setCurrentView} />
        <NavItem icon={Settings} label="Legal Resources" view="legal" currentView={currentView} onClick={setCurrentView} />
      </nav>
      <div className="mt-auto pt-4 border-t border-gray-700">
        <h3 className="text-xs text-gray-400 mb-1">Authenticated ID</h3>
        <p className="text-sm font-mono break-all leading-snug">
          {userId ? userId : <span className="text-red-400">Not Authenticated</span>}
        </p>
      </div>
    </div>
  );

  const DashboardHeader: React.FC<{ title: string }> = ({ title }) => (
    <div className="p-6 bg-gray-800 shadow-md flex justify-between items-center rounded-lg mb-6">
      <h2 className="text-3xl font-light text-white">
        {title}
      </h2>
      <div className="flex items-center space-x-2 text-sm text-gray-400">
        <LogIn className="w-4 h-4" />
        <span>Status: {isAuthReady ? 'ONLINE' : 'Authenticating...'}</span>
      </div>
    </div>
  );


  // --- View Components ---
  
  const DashboardView: React.FC = () => (
    <>
      <DashboardHeader title="Sovereign Finance Cockpit" />
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-2 space-y-6">
            <FDCPAConsole />
            <ModuleSection />
            <LogGenerator />
            <RemedyLog />
          </div>

          <div className="lg:col-span-1 space-y-6">
            {/* Identity & Status Profile Summary (Dashboard Card) */}
            <div className="bg-gray-900 p-6 rounded-xl shadow-2xl border border-gray-700">
              <h3 className="text-xl font-semibold text-white mb-4 flex items-center">
                <Shield className="w-5 h-5 mr-2 text-yellow-400" /> Identity & Status Profile
              </h3>
              <div className="space-y-3">
                <DetailRow label="Legal Entity Name" value={userProfile?.legalName || 'N/A'} />
                <DetailRow label="Living Name" value={userProfile?.livingName || 'N/A'} />
                <DetailRow label="Status" value={userProfile?.status || 'N/A'} statusColor={userProfile?.status === 'De Jure' ? "text-green-400" : "text-red-400"} />
                <DetailRow label="BC Authentication" value="Complete" statusColor="text-green-400" />
              </div>
            </div>

            {/* Tactical Status */}
            <div className="bg-gray-900 p-6 rounded-xl shadow-2xl border border-gray-700">
              <h3 className="text-xl font-semibold text-white mb-4 flex items-center">
                <Clock className="w-5 h-5 mr-2 text-pink-400" /> Sovereign Loop Tracker
              </h3>
              <DetailRow label="Stage" value="Validate" statusColor="text-yellow-400" />
              <DetailRow label="Creditors Tracked" value={creditors.length.toString()} />
              <DetailRow label="FDCPA Violations" value={fdcpaViolations.length.toString()} statusColor={fdcpaViolations.length > 0 ? "text-red-400" : "text-green-400"} />
              <DetailRow label="Remedy Tracks" value="2" />
            </div>
             {/* Auth Detail Card */}
            <div className="bg-gray-900 p-6 rounded-xl shadow-2xl border border-gray-700">
                <h3 className="text-xl font-semibold text-white mb-4 flex items-center">
                    <LogIn className="w-5 h-5 mr-2 text-gray-400" /> Authentication Details
                </h3>
                <div className="space-y-3">
                    <DetailRow label="Authenticated ID" value={userId} isID />
                    <DetailRow label="App ID" value={appId} isID />
                </div>
            </div>
          </div>
      </div>
    </>
  );
  
  const IdentityStatusConsole: React.FC = () => {
    const [editMode, setEditMode] = useState(false);
    const [editableProfile, setEditableProfile] = useState<UserProfile>(userProfile || MOCK_PROFILE);
    
    useEffect(() => {
        if (userProfile) {
            setEditableProfile(userProfile);
        }
    }, [userProfile]);

    const handleSave = () => {
        saveUserProfile(editableProfile);
        setEditMode(false);
    };

    return (
      <>
          <DashboardHeader title="Identity & Status Console" />
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div className="lg:col-span-2 space-y-6">
                  <div className="bg-gray-900 p-6 rounded-xl shadow-2xl border border-indigo-700">
                      <h3 className="text-2xl font-bold text-white mb-4 flex items-center justify-between">
                          <span className="flex items-center"><User className="w-6 h-6 mr-3 text-indigo-400" /> Identity Data Console</span>
                          <button 
                            onClick={() => editMode ? handleSave() : setEditMode(true)}
                            className={`px-4 py-2 rounded-lg font-semibold text-sm transition ${editMode ? 'bg-green-600 hover:bg-green-700' : 'bg-indigo-600 hover:bg-indigo-700'}`}
                          >
                              {editMode ? <span className="flex items-center"><CheckCircle className="w-4 h-4 mr-1"/> Save Profile</span> : <span className="flex items-center"><Edit className="w-4 h-4 mr-1"/> Edit Profile</span>}
                          </button>
                      </h3>
                      <p className="text-gray-400 mb-6">
                          Manage your legal identity details, which are automatically merged into all generated documents.
                      </p>

                      <div className="space-y-4">
                          <label className="block">
                              <span className="text-sm font-medium text-gray-400">Legal Entity Name (ALL CAPS)</span>
                              <input
                                  type="text"
                                  value={editableProfile.legalName}
                                  onChange={(e) => setEditableProfile({...editableProfile, legalName: e.target.value})}
                                  disabled={!editMode}
                                  className={`w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg text-white ${!editMode && 'opacity-70'}`}
                              />
                          </label>
                           <label className="block">
                              <span className="text-sm font-medium text-gray-400">Living Name (Secured Party Creditor)</span>
                              <input
                                  type="text"
                                  value={editableProfile.livingName}
                                  onChange={(e) => setEditableProfile({...editableProfile, livingName: e.target.value})}
                                  disabled={!editMode}
                                  className={`w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg text-white ${!editMode && 'opacity-70'}`}
                              />
                          </label>
                           <label className="block">
                              <span className="text-sm font-medium text-gray-400">Mailing/Contact Address</span>
                              <input
                                  type="text"
                                  value={editableProfile.address}
                                  onChange={(e) => setEditableProfile({...editableProfile, address: e.target.value})}
                                  disabled={!editMode}
                                  className={`w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg text-white ${!editMode && 'opacity-70'}`}
                              />
                          </label>
                          <label className="block">
                              <span className="text-sm font-medium text-gray-400">Private Trust ID / UCC Collateral ID</span>
                              <input
                                  type="text"
                                  value={editableProfile.trustId}
                                  onChange={(e) => setEditableProfile({...editableProfile, trustId: e.target.value})}
                                  disabled={!editMode}
                                  className={`w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg text-white ${!editMode && 'opacity-70'}`}
                              />
                          </label>
                      </div>
                  </div>

                  <div className="bg-gray-900 p-6 rounded-xl shadow-2xl border border-gray-700">
                      <h3 className="text-2xl font-bold text-white mb-4 flex items-center">
                          <Landmark className="w-6 h-6 mr-3 text-yellow-400" /> Status Correction & Perfection
                      </h3>
                      <p className="text-gray-400 mb-4">
                          This section guides the process of asserting your de jure status in commerce and perfecting claims.
                      </p>
                      <div className="space-y-3">
                          <DetailRow label="Birth Certificate Authentication" value="Federal Authentication Complete" statusColor="text-green-400" />
                          <DetailRow label="UCC-1 Financing Statement" value="Draft Generated (Ready for Filing)" statusColor="text-yellow-400" />
                          <DetailRow label="Affidavit of Fact" value="Generated & Sworn (9/1/2025)" statusColor="text-green-400" />
                      </div>
                      <button className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-5 rounded-lg transition mt-6">
                              Generate Status Correction Affidavit
                      </button>
                  </div>
              </div>
              
              <div className="lg:col-span-1 space-y-6">
                  <DialogosScan />
                  <LogGenerator />
              </div>
          </div>
      </>
    );
  };
  
  const InstrumentVaultConsole: React.FC = () => {
    return (
      <>
        <DashboardHeader title="Instrument Vault & OCR Analysis" />
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 space-y-6">
                
                {/* TILA & Contract Analysis */}
                <TILAValidation />

                {/* Monthly Bill Endorsement (UCC) */}
                <div className="bg-gray-900 p-6 rounded-xl shadow-2xl border border-gray-700">
                    <h3 className="text-2xl font-bold text-white mb-4 flex items-center">
                        <CreditCard className="w-6 h-6 mr-3 text-pink-400" /> Monthly Bill Endorsement (UCC)
                    </h3>
                    <p className="text-gray-400 mb-4">
                        Validate instrument negotiability and generate an **Accepted for Value (A4V)** Tender Letter/Notice of Acceptance for Value, asserting it as lawful tender.
                    </p>
                    <button
                        onClick={generateUCCNotice}
                        disabled={tenderNoticeLoading || !isAuthReady}
                        className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg transition disabled:bg-gray-600 flex items-center justify-center"
                    >
                        {tenderNoticeLoading ? (
                            <Loader className="w-5 h-5 animate-spin mr-2" />
                        ) : (
                            <File className="w-5 h-5 mr-2" />
                        )}
                        {tenderNoticeLoading ? 'Drafting Tender Notice...' : 'Generate A4V Tender Notice'}
                    </button>
                    {tenderNoticeOutput && (
                        <div className="mt-4 p-4 bg-gray-800 rounded-lg border border-indigo-700 relative">
                            <h4 className="font-semibold text-lg text-indigo-300 mb-2">RemedySynthesizer Draft:</h4>
                            <button 
                                onClick={() => copyToClipboard(tenderNoticeOutput.text)}
                                className="absolute top-4 right-4 text-gray-400 hover:text-white transition"
                            >
                                <ClipboardCopy className="w-5 h-5" />
                            </button>
                            <pre className="text-gray-200 text-xs whitespace-pre-wrap font-mono p-2 bg-gray-900 rounded border border-gray-700 max-h-48 overflow-y-auto">
                                {tenderNoticeOutput.text}
                            </pre>
                        </div>
                    )}
                </div>

                {/* Document Inventory Mock */}
                <div className="bg-gray-900 p-6 rounded-xl shadow-2xl border border-gray-700">
                    <h3 className="text-2xl font-bold text-white mb-4 flex items-center">
                        <FileSearch className="w-6 h-6 mr-3 text-blue-400" /> Document Inventory (Mock Data)
                    </h3>
                    <div className="space-y-4">
                        <div className="p-4 bg-gray-800 rounded-lg border-l-4 border-blue-500">
                            <DetailRow label="Name" value="Auto Loan Contract (TILA)" />
                            <DetailRow label="Type" value="Negotiable Instrument" />
                            <DetailRow label="Date Uploaded" value="2025-10-01" />
                            <DetailRow label="Status" value="Analysis Required" statusColor="text-yellow-400" />
                        </div>
                        <div className="p-4 bg-gray-800 rounded-lg border-l-4 border-blue-500">
                            <DetailRow label="Name" value="Credit Card Statement" />
                            <DetailRow label="Type" value="Statement of Account" />
                            <DetailRow label="Date Uploaded" value="2025-10-15" />
                            <DetailRow label="Status" value="Endorsed" statusColor="text-green-400" />
                        </div>
                    </div>
                </div>

            </div>

            <div className="lg:col-span-1 space-y-6">
                <LogGenerator />
                <RemedyLog />
            </div>
        </div>
      </>
    );
  };
  
  const TILAValidation: React.FC = () => (
      <div className="bg-gray-900 p-6 rounded-xl shadow-2xl border border-gray-700">
          <h3 className="text-2xl font-bold text-white mb-4 flex items-center">
              <FileSearch className="w-6 h-6 mr-3 text-green-400" /> TILA & Contract Analysis (JARVIS Agent)
          </h3>
          <p className="text-gray-400 mb-4">
              Analyze vehicle financing contracts for compliance with the Truth in Lending Act (TILA) and scan for hidden clauses (arbitration, fee traps).
          </p>
          <div className="flex flex-col space-y-3">
              <textarea
                value={tilaInput}
                onChange={(e) => setTilaInput(e.target.value)}
                placeholder="Paste TILA disclosure details, APR, Finance Charge, and any concerning clauses here..."
                rows={4}
                className="flex-grow p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-green-500 placeholder-gray-400 resize-none"
              />
              <button
                onClick={handleTilaAnalysis}
                disabled={tilaLoading || !tilaInput.trim()}
                className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg shadow-md transition duration-200 disabled:bg-gray-600 disabled:cursor-not-allowed flex items-center justify-center"
              >
                {tilaLoading ? (
                  <Loader className="w-5 h-5 animate-spin mr-2" />
                ) : (
                  <Zap className="w-5 h-5 mr-2" />
                )}
                {tilaLoading ? 'Analyzing Contract...' : 'Run TILA Validation'}
              </button>
          </div>

          {tilaAnalysisOutput && (
              <div className="mt-5 p-4 bg-gray-800 rounded-lg border border-green-700">
                  <h4 className="font-semibold text-lg text-green-300 mb-2">JARVIS Analysis Report:</h4>
                  <div className="space-y-2">
                      <DetailRow label="APR Disclosure Valid" value={tilaAnalysisOutput.aprValid ? 'YES' : 'NO'} statusColor={tilaAnalysisOutput.aprValid ? 'text-green-400' : 'text-red-400'} />
                      <DetailRow label="Finance Charge Valid" value={tilaAnalysisOutput.financeChargeValid ? 'YES' : 'NO'} statusColor={tilaAnalysisOutput.financeChargeValid ? 'text-green-400' : 'text-red-400'} />
                      <DetailRow label="Hidden Clauses Detected" value={tilaAnalysisOutput.hiddenFeesFound.join(', ')} statusColor={tilaAnalysisOutput.hiddenFeesFound.includes('None found') ? 'text-green-400' : 'text-red-400'} />
                      <p className="text-sm pt-2 border-t border-gray-700 mt-2">
                          <span className="font-medium text-gray-400">Remedy Guidance:</span> {tilaAnalysisOutput.remedyGuidance}
                      </p>
                  </div>
              </div>
          )}
      </div>
  );

  const RemedySynthesizerConsole: React.FC = () => (
      <>
        <DashboardHeader title="Remedy Synthesizer (Generative Agent)" />
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 space-y-6">
                <FDCPAConsole />

                {/* FCRA Dispute Letter Generation */}
                <div className="bg-gray-900 p-6 rounded-xl shadow-2xl border border-gray-700">
                    <h3 className="text-2xl font-bold text-white mb-4 flex items-center">
                        <ClipboardCopy className="w-6 h-6 mr-3 text-pink-400" /> FCRA Section 609 Dispute Letter
                    </h3>
                    <p className="text-gray-400 mb-4">
                        Generate a formal dispute letter asserting your rights under the FCRA to verify all reported accounts (Section 609/611).
                    </p>
                    <button
                        onClick={generateFCRADispute}
                        disabled={fcraDisputeLoading || !isAuthReady}
                        className="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-5 rounded-lg transition disabled:bg-gray-600 flex items-center justify-center"
                    >
                        {fcraDisputeLoading ? (
                            <Loader className="w-5 h-5 animate-spin mr-2" />
                        ) : (
                            <Send className="w-5 h-5 mr-2" />
                        )}
                        {fcraDisputeLoading ? 'Drafting FCRA Letter...' : 'Draft FCRA Section 609 Dispute'}
                    </button>
                    {fcraDisputeOutput && (
                        <div className="mt-4 p-4 bg-gray-800 rounded-lg border border-pink-700 relative">
                            <h4 className="font-semibold text-lg text-pink-300 mb-2">RemedySynthesizer Draft:</h4>
                            <button 
                                onClick={() => copyToClipboard(fcraDisputeOutput.text)}
                                className="absolute top-4 right-4 text-gray-400 hover:text-white transition"
                            >
                                <ClipboardCopy className="w-5 h-5" />
                            </button>
                            <pre className="text-gray-200 text-xs whitespace-pre-wrap font-mono p-2 bg-gray-900 rounded border border-gray-700 max-h-48 overflow-y-auto">
                                {fcraDisputeOutput.text}
                            </pre>
                        </div>
                    )}
                </div>


                <div className="bg-gray-900 p-6 rounded-xl shadow-2xl border border-gray-700">
                    <h3 className="text-2xl font-bold text-white mb-4 flex items-center">
                        <Zap className="w-6 h-6 mr-3 text-yellow-400" /> Custom Remedy Planning
                    </h3>
                    <p className="text-gray-400 mb-4">
                        Input your concept, and the **RemedySynthesizer** provides tactical guidance and the next three procedural steps in the Private Administrative Process.
                    </p>
                    <div className="flex flex-col space-y-3">
                        <textarea
                          value={remedyIdea}
                          onChange={(e) => setRemedyIdea(e.target.value)}
                          placeholder="e.g., How do I properly notice a public servant that they are personally liable for their de facto actions?"
                          rows={3}
                          className="flex-grow p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-yellow-500 placeholder-gray-400 resize-none"
                        />
                        <button
                          onClick={handleRemedyIdea}
                          disabled={remedyIdeaLoading || !remedyIdea.trim()}
                          className="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-5 rounded-lg shadow-md transition duration-200 disabled:bg-gray-600 disabled:cursor-not-allowed flex items-center justify-center"
                        >
                          {remedyIdeaLoading ? (
                            <Loader className="w-5 h-5 animate-spin mr-2" />
                          ) : (
                            <Zap className="w-5 h-5 mr-2" />
                          )}
                          {remedyIdeaLoading ? 'Synthesizing Plan...' : 'Analyze & Plan Remedy'}
                        </button>
                    </div>

                    {remedyIdeaOutput && (
                        <div className="mt-5 p-4 bg-gray-800 rounded-lg border border-yellow-700">
                          <h4 className="font-semibold text-lg text-yellow-300 mb-2">Tactical Guidance:</h4>
                          <div className="text-gray-200 whitespace-pre-wrap mb-4 border-l-2 border-yellow-500 pl-3">
                            {remedyIdeaOutput.text}
                          </div>
                        </div>
                      )}
                </div>
            </div>

            <div className="lg:col-span-1 space-y-6">
                <div className="bg-gray-900 p-6 rounded-xl shadow-2xl border border-gray-700">
                    <h3 className="text-xl font-semibold text-white mb-4 flex items-center">
                        <FileText className="w-5 h-5 mr-2 text-indigo-400" /> Quick-Draft Templates
                    </h3>
                    <div className="space-y-3">
                        <button className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg transition">
                            Affidavit of Default
                        </button>
                        <button className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg transition">
                            Formal Demand Letter
                        </button>
                        <button className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg transition">
                            Notice of Fault
                        </button>
                    </div>
                </div>
                <RemedyLog />
            </div>
        </div>
      </>
  );

  const CreditorAddressBookConsole: React.FC = () => (
      <>
        <DashboardHeader title="Creditor Address Book" />
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 space-y-6">
                <div className="bg-gray-900 p-6 rounded-xl shadow-2xl border border-gray-700">
                    <h3 className="text-2xl font-bold text-white mb-4 flex items-center">
                        <Plus className="w-6 h-6 mr-3 text-green-400" /> Add New Creditor
                    </h3>
                    <p className="text-gray-400 mb-4">
                        Add creditors and debt collectors to your secure, private address book.
                    </p>
                    <div className="space-y-3">
                        <input
                            type="text"
                            value={newCreditor.name}
                            onChange={(e) => setNewCreditor({...newCreditor, name: e.target.value})}
                            placeholder="Creditor / Collector Name"
                            className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white"
                        />
                        <input
                            type="text"
                            value={newCreditor.accountNumber}
                            onChange={(e) => setNewCreditor({...newCreditor, accountNumber: e.target.value})}
                            placeholder="Account Number (Optional)"
                            className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white"
                        />
                        <input
                            type="text"
                            value={newCreditor.address}
                            onChange={(e) => setNewCreditor({...newCreditor, address: e.target.value})}
                            placeholder="Mailing Address for Remedy"
                            className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white"
                        />
                        <button onClick={addCreditor} disabled={!newCreditor.name || !isAuthReady} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg transition disabled:bg-gray-600">
                            Add Creditor
                        </button>
                    </div>
                </div>

                <div className="bg-gray-900 p-6 rounded-xl shadow-2xl border border-gray-700">
                    <h3 className="text-2xl font-bold text-white mb-4 flex items-center">
                        <Users className="w-6 h-6 mr-3 text-indigo-400" /> Creditor List ({creditors.length})
                    </h3>
                    <div className="max-h-96 overflow-y-auto space-y-2">
                        {creditors.length === 0 ? (
                            <p className="text-gray-500 text-center py-4">No creditors in your address book.</p>
                        ) : (
                            creditors.map((c) => (
                                <div key={c.id} className="p-3 bg-gray-800 rounded-lg border-l-4 border-indigo-500">
                                    <DetailRow label="Name" value={c.name} />
                                    <DetailRow label="Account" value={c.accountNumber || 'N/A'} />
                                    <DetailRow label="Address" value={c.address} />
                                    <DetailRow label="Status" value={c.status} statusColor={c.status === 'Discharged' ? 'text-green-400' : c.status === 'Disputed' ? 'text-yellow-400' : 'text-gray-400'} />
                                </div>
                            ))
                        )}
                    </div>
                </div>
            </div>
            <div className="lg:col-span-1 space-y-6">
                <FDCPAConsole />
                <LogGenerator />
            </div>
        </div>
      </>
  );

  const LegalResourcesConsole: React.FC = () => (
      <>
        <DashboardHeader title="Legal Resources & Intelligence" />
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 space-y-6">
                <DialogosScan />

                <div className="bg-gray-900 p-6 rounded-xl shadow-2xl border border-gray-700">
                    <h3 className="text-2xl font-bold text-white mb-4 flex items-center">
                        <BookOpen className="w-6 h-6 mr-3 text-red-400" /> Sovereign Doctrine Library
                    </h3>
                    <p className="text-gray-400 mb-4">
                        Curated links and summaries of foundational commercial law, case law, and philosophical commentary.
                    </p>
                    <div className="space-y-3 text-sm">
                        <p className="bg-gray-800 p-3 rounded-lg border-l-4 border-red-500 flex items-center"><Link className="w-4 h-4 mr-2"/> Uniform Commercial Code (UCC) Article 3: Negotiable Instruments</p>
                        <p className="bg-gray-800 p-3 rounded-lg border-l-4 border-red-500 flex items-center"><Link className="w-4 h-4 mr-2"/> Fair Debt Collection Practices Act (FDCPA) Full Text</p>
                        <p className="bg-gray-800 p-3 rounded-lg border-l-4 border-red-500 flex items-center"><Link className="w-4 h-4 mr-2"/> Key Case Law: US Supreme Court on *De Jure* Capacity</p>
                        <p className="bg-gray-800 p-3 rounded-lg border-l-4 border-red-500 flex items-center"><Link className="w-4 h-4 mr-2"/> Philosophical Commentary: The Living Man vs. Legal Fiction</p>
                    </div>
                </div>
            </div>

            <div className="lg:col-span-1 space-y-6">
                <LogGenerator />
                <RemedyLog />
            </div>
        </div>
      </>
  );

  // --- Console Helper Components (FDCPA and Logging, used in multiple views) ---

  const LogGenerator: React.FC = () => (
    <div className="bg-gray-900 p-5 rounded-xl shadow-2xl border border-gray-700">
      <h3 className="text-xl font-semibold text-indigo-400 mb-3">
        Simulate Provenance Event (Public)
      </h3>
      <div className="flex space-x-3">
        <input
          type="text"
          value={logMessage}
          onChange={(e) => setLogMessage(e.target.value)}
          placeholder="e.g., Generated Affidavit of Fact"
          className="flex-grow p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-gray-400"
        />
        <button
          onClick={handleLogEvent}
          disabled={!isAuthReady || !logMessage.trim()}
          className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg shadow-md transition duration-200 disabled:bg-gray-600 disabled:cursor-not-allowed flex items-center"
        >
          <Zap className="w-5 h-5 mr-2" /> Log Event
        </button>
      </div>
      <p className="text-xs text-gray-500 mt-2">
        Adds a transaction to the shared, real-time Provenance Log (Public Data).
      </p>
    </div>
  );

  const RemedyLog: React.FC = () => (
    <div className="bg-gray-900 p-5 rounded-xl shadow-2xl border border-gray-700 h-96 overflow-y-auto">
      <h3 className="text-xl font-semibold text-indigo-400 mb-4 flex items-center">
        <Database className="w-5 h-5 mr-2" /> Provenance Remedy Log (Public)
      </h3>
      <table className="min-w-full text-sm text-left text-gray-300">
        <thead>
          <tr className="border-b border-gray-700 text-xs uppercase text-gray-400 tracking-wider">
            <th scope="col" className="py-2 px-1">Time</th>
            <th scope="col" className="py-2 px-3">Event</th>
            <th scope="col" className="py-2 px-3">Module</th>
            <th scope="col" className="py-2 px-3">User (ID)</th>
          </tr>
        </thead>
        <tbody>
          {remedyLogs.length === 0 ? (
            <tr>
              <td colSpan={4} className="py-4 text-center text-gray-500">
                {isAuthReady ? 'No events logged yet.' : 'Awaiting authentication to load logs...'}
              </td>
            </tr>
          ) : (
            remedyLogs.map((log) => (
              <tr key={log.id} className="border-b border-gray-800 hover:bg-gray-800 transition-colors">
                <td className="py-2 px-1 font-mono text-xs">{log.timestamp}</td>
                <td className="py-2 px-3 font-medium text-white">{log.event}</td>
                <td className="py-2 px-3 text-indigo-300">{log.module}</td>
                <td className="py-2 px-3 font-mono text-gray-400">{log.userId}</td>
              </tr>
            ))
          )}
        </tbody>
      </table>
    </div>
  );

  const ModuleSection: React.FC = () => (
      <div className="mt-6 bg-gray-900 p-6 rounded-xl shadow-2xl border border-gray-700">
        <h3 className="text-2xl font-semibold text-white mb-6 flex items-center">
            <BookOpen className="w-6 h-6 mr-3 text-red-400" /> Sovereign Loop: Core Modules
        </h3>
        <p className="text-gray-400 mb-6">
            The Sovereign Loop tracks your progress through Intake, Validate, Remedy, Log, and Reflect stages via these integrated systems.
        </p>
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {coreModules.map((module, index) => (
              <ModuleCard key={index} name={module.name} description={module.description} />
            ))}
        </div>
      </div>
  );

  const DialogosScan: React.FC = () => (
    <div className="bg-gray-900 p-5 rounded-xl shadow-2xl border border-gray-700">
      <h3 className="text-xl font-semibold text-red-400 mb-3 flex items-center">
        <Search className="w-5 h-5 mr-2" /> Dialogos Agent: Semantic Scan
      </h3>
      <p className="text-sm text-gray-400 mb-3">
        Enter a phrase or paragraph for deep philosophical and commercial law analysis (e.g., semantic traps). Uses Gemini API with **Google Search Grounding**.
      </p>

      <div className="flex flex-col space-y-3">
        <textarea
          value={dialogosInput}
          onChange={(e) => setDialogosInput(e.target.value)}
          placeholder="Enter text to analyze..."
          rows={3}
          className="flex-grow p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-red-500 placeholder-gray-400 resize-none"
        />
        <button
          onClick={handleDialogosScan}
          disabled={dialogosLoading || !dialogosInput.trim()}
          className="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-5 rounded-lg shadow-md transition duration-200 disabled:bg-gray-600 disabled:cursor-not-allowed flex items-center justify-center"
        >
          {dialogosLoading ? (
            <Loader className="w-5 h-5 animate-spin mr-2" />
          ) : (
            <Zap className="w-5 h-5 mr-2" />
          )}
          {dialogosLoading ? 'Scanning...' : 'Run Semantic Scan'}
        </button>
      </div>

      {dialogosOutput && (
        <div className="mt-5 p-4 bg-gray-800 rounded-lg border border-red-700">
          <h4 className="font-semibold text-lg text-red-300 mb-2">Tactical Analysis Result:</h4>
          <div className="text-gray-200 whitespace-pre-wrap mb-4 border-l-2 border-red-500 pl-3">
            {dialogosOutput.text}
          </div>

          {dialogosOutput.sources.length > 0 && (
            <div className="text-xs text-gray-500 pt-2 border-t border-gray-700">
              <span className="font-bold text-red-400 flex items-center mb-1">
                <Link className="w-3 h-3 mr-1" /> Grounding Sources ({dialogosOutput.sources.length})
              </span>
              <ul className="space-y-1">
                {dialogosOutput.sources.map((source, index) => (
                  <li key={index} className="truncate hover:text-red-300">
                    <a href={source.uri} target="_blank" rel="noopener noreferrer" className="underline">
                      {source.title}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>
      )}
    </div>
  );

  const FDCPAConsole: React.FC = () => (
      <div className="bg-gray-900 p-5 rounded-xl shadow-2xl border border-gray-700">
          <h3 className="text-xl font-semibold text-orange-400 mb-3 flex items-center">
              <Shield className="w-5 h-5 mr-2" /> FDCPA Console: Violation & Remedy
          </h3>

          <div className="mb-6 pb-4 border-b border-gray-700">
              <h4 className="text-lg font-medium text-gray-300 mb-2">1. Log New Violation (Private Log)</h4>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <input
                      type="text"
                      value={newViolation.collector}
                      onChange={(e) => setNewViolation(prev => ({...prev, collector: e.target.value}))}
                      placeholder="Debt Collector Name"
                      className="p-2 bg-gray-700 border border-gray-600 rounded text-white"
                  />
                  <select
                      value={newViolation.type}
                      onChange={(e) => setNewViolation(prev => ({...prev, type: e.target.value}))}
                      className="p-2 bg-gray-700 border border-gray-600 rounded text-white appearance-none"
                  >
                      {violationOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                  </select>
                  <button
                      onClick={logFDCPAViolation}
                      disabled={!newViolation.collector || !isAuthReady}
                      className="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded transition disabled:bg-gray-600 flex items-center justify-center"
                  >
                      <Plus className="w-4 h-4 mr-2" /> Log Event
                  </button>
              </div>
              <textarea
                  value={newViolation.details}
                  onChange={(e) => setNewViolation(prev => ({...prev, details: e.target.value}))}
                  placeholder="Specific Details of Violation..."
                  rows={2}
                  className="w-full mt-3 p-2 bg-gray-700 border border-gray-600 rounded text-white resize-none"
              />
          </div>

          <div className="mb-6">
              <h4 className="text-lg font-medium text-gray-300 mb-2">2. Generate Remedy: Cease & Desist</h4>
              <button
                  onClick={generateCeaseAndDestist}
                  disabled={ceaseDesistLoading || fdcpaViolations.length === 0}
                  className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition disabled:bg-gray-600 flex items-center justify-center"
              >
                  {ceaseDesistLoading ? (
                      <Loader className="w-5 h-5 animate-spin mr-2" />
                  ) : (
                      <Mail className="w-5 h-5 mr-2" />
                  )}
                  {ceaseDesistLoading ? 'Drafting C&D Letter...' : `Generate C&D (Based on ${fdcpaViolations.length} Violations)`}
              </button>
          </div>

          <div className="max-h-60 overflow-y-auto border-t border-gray-700 pt-4">
              <h4 className="text-lg font-medium text-gray-300 mb-3">Logged Violations (Private)</h4>
              <ul className="space-y-2">
                  {fdcpaViolations.length === 0 ? (
                      <li className="text-gray-500 text-sm">No violations logged yet. Log an event to begin remedy.</li>
                  ) : (
                      fdcpaViolations.map((v, index) => (
                          <li key={v.id} className="bg-gray-800 p-3 rounded border-l-4 border-orange-500">
                              <span className="font-semibold text-sm text-white mr-2">{v.debtCollector}</span>
                              <span className="text-xs text-gray-400">({v.date})</span>
                              <p className="text-xs text-orange-300 mt-1">{v.violationType}</p>
                          </li>
                      ))
                  )}
              </ul>
          </div>

          {ceaseDesistOutput && (
            <div className="mt-5 p-4 bg-gray-800 rounded-lg border border-blue-700 relative">
              <h4 className="font-semibold text-lg text-blue-300 mb-2">RemedySynthesizer Draft:</h4>
              <button 
                  onClick={() => copyToClipboard(ceaseDesistOutput.text)}
                  className="absolute top-4 right-4 text-gray-400 hover:text-white transition"
              >
                  <ClipboardCopy className="w-5 h-5" />
              </button>
              <pre className="text-gray-200 text-xs whitespace-pre-wrap font-mono p-2 bg-gray-900 rounded border border-gray-700 max-h-48 overflow-y-auto">
                {ceaseDesistOutput.text}
              </pre>
            </div>
          )}
      </div>
  );
  
  // Conditional rendering based on the currentView state
  const renderView = useMemo(() => {
    switch (currentView) {
      case 'identity':
        return <IdentityStatusConsole />;
      case 'vault':
        return <InstrumentVaultConsole />;
      case 'remedy':
        return <RemedySynthesizerConsole />;
      case 'creditors':
        return <CreditorAddressBookConsole />;
      case 'legal':
        return <LegalResourcesConsole />;
      case 'dashboard':
      default:
        return <DashboardView />;
    }
  }, [currentView, userId, appId, fdcpaViolations, dialogosInput, dialogosOutput, dialogosLoading, logMessage, ceaseDesistOutput, ceaseDesistLoading, remedyIdea, remedyIdeaOutput, remedyIdeaLoading, userProfile, creditors, tilaInput, tilaAnalysisOutput, tilaLoading, tenderNoticeOutput, tenderNoticeLoading, fcraDisputeOutput, fcraDisputeLoading]);


  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-950 text-white">
        <Loader className="w-8 h-8 animate-spin text-indigo-500 mr-3" />
        <span className="text-xl">Initializing Sovereign Intelligence Engine...</span>
      </div>
    );
  }

  return (
    <div className="min-h-screen flex bg-gray-950 text-white font-sans">
      <Sidebar />
      <main className="flex-1 p-8 overflow-y-auto">
        {renderView}
      </main>
    </div>
  );
};

export default App;